<div class="products">
  <div class="products-header">
    <div class="header-content">
      <h1>Produtos</h1>
      <p class="subtitle">Gerencie seu catálogo de produtos</p>
    </div>
    <div class="header-actions">
      <app-view-toggle 
        [currentView]="currentView"
        (viewChange)="onViewChange($event)">
      </app-view-toggle>
      <button class="btn btn-primary" (click)="addProduct()">
        <i class="pi pi-plus"></i>
        Adicionar Produto
      </button>
    </div>
  </div>

  <!-- Controles da página -->
  <div class="page-controls">
    <!-- Primeira linha: Busca, Categorias, Status e Limpar -->
    <div class="filters-row">
      <input 
        type="text" 
        placeholder="Buscar por nome ou SKU..."
        class="form-control search-input"
        [(ngModel)]="searchTerm"
        (input)="filterProducts()">
      
      <app-multi-select
        [options]="categoryOptions"
        placeholder="Selecionar categorias..."
        (selectionChange)="onCategorySelectionChange($event)">
      </app-multi-select>

      <button 
        type="button" 
        class="btn btn-secondary clear-filters-btn"
        (click)="clearFilters()">
        <i class="pi pi-filter-slash"></i>
        Limpar Filtros
      </button>
    </div>

    <!-- Segunda linha: Status e Estoque -->
    <div class="filters-row">
      <div class="selects-group">
        <select 
          [(ngModel)]="selectedStatus" 
          (change)="filterProducts()"
          class="form-control status-select">
          @for (status of statusOptions; track status.value) {
            <option [value]="status.value">
              {{ status.label }}
            </option>
          }
        </select>

        <select 
          [(ngModel)]="selectedStockFilter" 
          (change)="filterProducts()"
          class="form-control stock-select">
          @for (stock of stockFilterOptions; track stock.value) {
            <option [value]="stock.value">
              {{ stock.label }}
            </option>
          }
        </select>
      </div>
    </div>

    <!-- Terceira linha: Preços -->
    <div class="filters-row">

      <div class="price-range">
        <input 
          type="number" 
          placeholder="Preço mínimo"
          class="form-control price-input"
          [(ngModel)]="minPrice"
          (input)="filterProducts()">
        <span class="price-separator">até</span>
        <input 
          type="number" 
          placeholder="Preço máximo"
          class="form-control price-input"
          [(ngModel)]="maxPrice"
          (input)="filterProducts()">
      </div>
    </div>
  </div>

  <!-- Visualização de Produtos -->
  <!-- Tabela -->
  @if (currentView === 'table') {
    <div class="products-table-container">
    <table class="products-table">
      <thead>
        <tr>
          <th>Imagem</th>
          <th>Nome</th>
          <th>Categoria</th>
          <th>SKU</th>
          <th>Preço</th>
          <th>Estoque</th>
          <th>Status</th>
          <th>Última Atualização</th>
          <th>Ações</th>
        </tr>
      </thead>
      <tbody>
        @for (product of getPaginatedProducts(); track product.id) {
          <tr>
          <td class="product-image">
            @if (product.images && product.images.length > 0) {
              <img [src]="product.images[0]" [alt]="product.name" class="product-thumbnail" (error)="onImageError($event)">
            } @else {
              <div class="no-image-thumbnail">
                <i class="pi pi-image"></i>
              </div>
            }
          </td>
          <td class="product-name">
            <strong>{{ product.name }}</strong>
          </td>
          <td class="category">{{ product.category?.name || 'Sem categoria' }}</td>
          <td class="sku">{{ product.sku }}</td>
          <td class="price">R$ {{ product.price | number:'1.2-2' }}</td>
          <td class="stock">
            <span [class]="(product.stock || 0) < 5 ? 'low-stock' : ''">
              {{ product.stock || 0 }}
            </span>
          </td>
          <td>
            <span class="status-badge" [class]="getStatusClass(product.status)">
              {{ getStatusText(product.status) }}
            </span>
          </td>
          <td class="date">{{ product.lastUpdated | date:'dd/MM/yyyy' }}</td>
          <td class="actions">
            <button class="btn btn-ghost btn-sm" (click)="editProduct(product)">
              <i class="pi pi-pencil"></i>
              Editar
            </button>
            @if (product.status === 'ACTIVE') {
              <button class="btn btn-ghost btn-sm text-warning" (click)="deactivateProduct(product)">
                <i class="pi pi-pause"></i>
                Desativar
              </button>
            } @else {
              <button class="btn btn-ghost btn-sm text-success" (click)="activateProduct(product)">
                <i class="pi pi-play"></i>
                Ativar
              </button>
              <button class="btn btn-ghost btn-sm text-danger" (click)="deleteProduct(product)">
                <i class="pi pi-trash"></i>
                Excluir
              </button>
            }
          </td>
          </tr>
        }
      </tbody>
    </table>
    </div>
  }

  <!-- Cards -->
  @if (currentView === 'cards') {
    <div class="products-cards-container">
      <div class="products-grid">
        @for (product of getPaginatedProducts(); track product.id) {
          <div class="product-card">
        <div class="card-header">
          <h3 class="product-name">{{ product.name }}</h3>
          <span class="status-badge" [class]="getStatusClass(product.status)">
            {{ getStatusText(product.status) }}
          </span>
        </div>
        
        <div class="card-body">
          <!-- Product Images -->
          @if (product.images && product.images.length > 0) {
            <div class="product-images">
              <div class="image-gallery">
                @for (image of product.images; track $index) {
                  <div class="image-item">
                    <img [src]="image" [alt]="product.name" (error)="onImageError($event)">
                  </div>
                }
              </div>
            </div>
          } @else {
            <div class="no-image">
              <i class="pi pi-image"></i>
              <span>Sem imagem</span>
            </div>
          }
          
          <div class="product-info">
            <div class="info-item">
              <span class="label">Categoria:</span>
              <span class="value">{{ product.category?.name || 'Sem categoria' }}</span>
            </div>
            <div class="info-item">
              <span class="label">SKU:</span>
              <span class="value sku">{{ product.sku }}</span>
            </div>
            <div class="info-item">
              <span class="label">Preço:</span>
              <span class="value price">R$ {{ product.price | number:'1.2-2' }}</span>
            </div>
            <div class="info-item">
              <span class="label">Estoque:</span>
              <span class="value stock" [class]="(product.stock || 0) < 5 ? 'low-stock' : ''">
                {{ product.stock || 0 }}
              </span>
            </div>
            <div class="info-item">
              <span class="label">Atualizado:</span>
              <span class="value date">{{ product.lastUpdated | date:'dd/MM/yyyy' }}</span>
            </div>
          </div>
        </div>
        
        <div class="card-footer">
            <button class="btn btn-ghost btn-sm" (click)="editProduct(product)">
              <i class="pi pi-pencil"></i>
              Editar
            </button>
            @if (product.status === 'ACTIVE') {
              <button class="btn btn-ghost btn-sm text-warning" (click)="deactivateProduct(product)">
                <i class="pi pi-pause"></i>
                Desativar
              </button>
            } @else {
              <button class="btn btn-ghost btn-sm text-success" (click)="activateProduct(product)">
                <i class="pi pi-play"></i>
                Ativar
              </button>
              <button class="btn btn-ghost btn-sm text-danger" (click)="deleteProduct(product)">
                <i class="pi pi-trash"></i>
                Excluir
              </button>
            }
        </div>
          </div>
        }
      </div>
    </div>
  }

  <!-- Estado vazio -->
  @if (filteredProducts.length === 0) {
    <div class="no-results">
      <i class="pi pi-search"></i>
      <p>Nenhum produto encontrado</p>
    </div>
  }

  <!-- Paginação -->
  @if (paginationConfig.totalItems > 5) {
    <app-pagination 
      [config]="paginationConfig"
      (pageChange)="onPageChange($event)"
      (itemsPerPageChange)="onItemsPerPageChange($event)">
    </app-pagination>
  }

  <!-- Modal de Adicionar/Editar Produto -->
  @if (showAddModal) {
    <div class="modal-overlay" (click)="closeModal()">
    <div class="modal" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h3>{{ editingProduct ? 'Editar Produto' : 'Adicionar Produto' }}</h3>
        <button class="btn-close" (click)="closeModal()">
          <i class="pi pi-times"></i>
        </button>
      </div>
      <div class="modal-body">
        <form>
          <div class="form-group">
            <label>Nome do Produto</label>
            <input 
              type="text" 
              [(ngModel)]="editingProduct!.name"
              name="name"
              class="form-control"
              placeholder="Digite o nome do produto">
          </div>
          <div class="form-row">
            <div class="form-group">
              <label>Categoria</label>
              <select 
                [(ngModel)]="editingProduct!.categoryId"
                name="category"
                class="form-control">
                <option value="">Selecione uma categoria</option>
                @for (category of categories; track category.id) {
                  <option [value]="category.id">
                    {{ category.name }}
                  </option>
                }
              </select>
            </div>
            <div class="form-group">
              <label>Fornecedor</label>
              <select 
                [(ngModel)]="editingProduct!.supplierId"
                name="supplier"
                class="form-control">
                <option value="">Selecione um fornecedor</option>
                @for (supplier of suppliers; track supplier.id) {
                  <option [value]="supplier.id">
                    {{ supplier.name }}
                  </option>
                }
              </select>
            </div>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label>SKU</label>
              <input 
                type="text" 
                [(ngModel)]="editingProduct!.sku"
                name="sku"
                class="form-control"
                placeholder="Código do produto">
            </div>
            <div class="form-group">
              <label>Preço de Custo</label>
              <input 
                type="number" 
                [(ngModel)]="editingProduct!.costPrice"
                name="costPrice"
                class="form-control"
                step="0.01"
                placeholder="0.00">
            </div>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label>Preço de Venda</label>
              <input 
                type="number" 
                [(ngModel)]="editingProduct!.price"
                name="price"
                class="form-control"
                step="0.01"
                placeholder="0.00">
            </div>
            <div class="form-group">
              <label>Estoque</label>
              <input 
                type="number" 
                [(ngModel)]="editingProduct!.stock"
                name="stock"
                class="form-control"
                placeholder="Quantidade em estoque">
            </div>
          </div>
          
          <div class="form-group">
            <label>Imagens do Produto (máximo 5)</label>
            <div class="image-upload-area">
              <input 
                type="file" 
                id="imageUpload" 
                multiple 
                accept="image/*" 
                (change)="onImageSelect($event)"
                style="display: none;">
              <label for="imageUpload" class="upload-button">
                <i class="pi pi-cloud-upload"></i>
                <span>Selecionar Imagens</span>
              </label>
              
              @if (editingProduct!.images && editingProduct!.images.length > 0) {
                <div class="image-preview-list">
                  @for (image of editingProduct!.images; track $index) {
                    <div class="image-preview-item">
                      <img [src]="image" [alt]="'Imagem ' + ($index + 1)">
                      <button type="button" class="remove-image" (click)="removeImage($index)">
                        <i class="pi pi-times"></i>
                      </button>
                    </div>
                  }
                </div>
              }
              @else if (selectedPreviews.length > 0) {
                <div class="image-preview-list">
                  @for (image of selectedPreviews; track $index) {
                    <div class="image-preview-item">
                      <img [src]="image" [alt]="'Imagem ' + ($index + 1)">
                      <button type="button" class="remove-image" (click)="removeImage($index)">
                        <i class="pi pi-times"></i>
                      </button>
                    </div>
                  }
                </div>
              }
            </div>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" (click)="closeModal()">Cancelar</button>
        <button class="btn btn-primary" (click)="saveProduct()">
          {{ editingProduct ? 'Salvar Alterações' : 'Adicionar Produto' }}
        </button>
      </div>
    </div>
    </div>
  }
</div>
